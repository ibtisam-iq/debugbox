name: CI â€“ Build, Validate & Smoke Test

# ------------------------------------------------------------
# Triggers
# ------------------------------------------------------------
# CI runs on:
# - pushes to main (continuous validation)
# - pull requests (contributor safety)
#
# This CI does NOT publish images.
# Publishing is handled by a separate release workflow.
# ------------------------------------------------------------
on:
  push:
    branches: [ main ]
    paths:
      - 'dockerfiles/**'
      - 'tests/**'
      - '.github/workflows/ci.yml'
  pull_request:
    paths:
      - 'dockerfiles/**'
      - 'tests/**'
      - '.github/workflows/ci.yml'

# ------------------------------------------------------------
# Permissions (least privilege)
# ------------------------------------------------------------
permissions:
  contents: read

# ------------------------------------------------------------
# Jobs
# ------------------------------------------------------------
jobs:
  build-and-smoke-test:
    name: Build & CI Smoke Test
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------
      # Checkout
      # ------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------
      # Enable multi-arch emulation
      # (required for arm64 validation)
      # ------------------------------------------------------
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: amd64,arm64

      # ------------------------------------------------------
      # Docker Buildx
      # ------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ------------------------------------------------
      # Install Trivy
      # ------------------------------------------------
      - name: Install Trivy
        uses: aquasecurity/trivy-action@v0.33.1
        with:
          install-only: true  

      # ======================================================
      # Base image (build validation only)
      # ======================================================
      - name: Build base image (validation only)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: dockerfiles/Dockerfile.base
          platforms: linux/amd64
          load: true
          push: false
          tags: debugbox-base:ci

      # ======================================================
      # Lite variant
      # ======================================================
      - name: Build lite image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: dockerfiles/Dockerfile.lite
          platforms: linux/amd64
          load: true
          push: false
          tags: debugbox-lite:ci

      - name: CI smoke test - lite
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/tests:/tests:ro \
            debugbox-lite:ci \
            sh /tests/ci-smoke.sh

      - name: Trivy scan lite image
        run: |
          trivy image \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            debugbox-lite:ci      

      # ======================================================
      # Balanced variant
      # ======================================================
      - name: Build balanced image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: dockerfiles/Dockerfile.balanced
          platforms: linux/amd64
          load: true
          push: false
          tags: debugbox-balanced:ci

      - name: CI smoke test - balanced
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/tests:/tests:ro \
            debugbox-balanced:ci \
            sh /tests/ci-smoke.sh

      - name: Trivy scan balanced image
        run: |
          trivy image \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            debugbox-balanced:ci      

      # ======================================================
      # Power variant
      # ======================================================
      - name: Build power image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: dockerfiles/Dockerfile.power
          platforms: linux/amd64
          load: true
          push: false
          tags: debugbox-power:ci

      - name: CI smoke test - power
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/tests:/tests:ro \
            debugbox-power:ci \
            sh /tests/ci-smoke.sh

      - name: Trivy scan power image
        run: |
          trivy image \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            debugbox-power:ci      
