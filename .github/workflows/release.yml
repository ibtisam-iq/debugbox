name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  release:
    name: Build, Scan & Push (Atomic)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: amd64,arm64

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Stage 1: Build amd64 only for scanning
      - name: Build all variants (amd64 for scan)
        run: |
          set -e
          variants=("lite" "balanced" "power")
          VERSION="${{ steps.version.outputs.version }}"
          echo "Building all variants (amd64 for scanning)..."
          for variant in "${variants[@]}"; do
            echo "Building $variant (amd64)..."
            docker buildx build \
              --file dockerfiles/Dockerfile.$variant \
              --platform linux/amd64 \
              --tag scan-$variant:$VERSION \
              --output type=docker,dest=/tmp/$variant-amd64.tar \
              .
            echo "Exported $variant to /tmp/$variant-amd64.tar"
          done

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sh -s -- -b /usr/local/bin v0.68.2
          trivy --version

      # Stage 2: Scan all variants
      - name: Scan all variants
        run: |
          set -e
          variants=("lite" "balanced" "power")
          VERSION="${{ steps.version.outputs.version }}"
          echo "Scanning all variants for HIGH/CRITICAL vulnerabilities..."
          for variant in "${variants[@]}"; do
            echo "Scanning $variant..."
            trivy image \
              --input /tmp/$variant-amd64.tar \
              --severity HIGH,CRITICAL \
              --exit-code 1 \
              scan-$variant:$VERSION
            echo "Scan passed for $variant"
          done

      # Stage 3: Push multi-platform only if all scans passed
      - name: Push all variants (atomic, 20 tags)
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          set -e
          variants=("lite" "balanced" "power")
          VERSION="${{ steps.version.outputs.version }}"
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          VCS_REF="${{ github.sha }}"

          echo "All scans passed ‚Äî starting atomic push (20 tags)..."

          for variant in "${variants[@]}"; do
            echo "Pushing $variant..."
            
            # Build tag list for each variant (quoted for safety)
            TAGS=(
              "--tag" "ghcr.io/ibtisam-iq/debugbox:$variant"
              "--tag" "ghcr.io/ibtisam-iq/debugbox:$variant-latest"
              "--tag" "ghcr.io/ibtisam-iq/debugbox:$variant-$VERSION"
              "--tag" "docker.io/$DOCKER_USERNAME/debugbox:$variant"
              "--tag" "docker.io/$DOCKER_USERNAME/debugbox:$variant-latest"
              "--tag" "docker.io/$DOCKER_USERNAME/debugbox:$variant-$VERSION"
            )
            
            # Add balanced aliases (2 extra tags: :latest and :VERSION)
            if [ "$variant" = "balanced" ]; then
              TAGS+=(
                "--tag" "ghcr.io/ibtisam-iq/debugbox:latest"
                "--tag" "ghcr.io/ibtisam-iq/debugbox:$VERSION"
                "--tag" "docker.io/$DOCKER_USERNAME/debugbox:latest"
                "--tag" "docker.io/$DOCKER_USERNAME/debugbox:$VERSION"
              )
            fi
            
            # Single atomic push per variant
            docker buildx build \
              --file "dockerfiles/Dockerfile.$variant" \
              --platform linux/amd64,linux/arm64 \
              --build-arg BUILD_DATE="$BUILD_DATE" \
              --build-arg VCS_REF="$VCS_REF" \
              --build-arg VERSION="$VERSION" \
              "${TAGS[@]}" \
              --pull \
              --push \
              .
            
            echo "Pushed $variant"
          done

      - name: Release summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo ""
          echo "Release v${VERSION} completed successfully!"
          echo ""
          echo "Published images (20 tags across 2 registries):"
          echo ""
          echo "Lite variant:"
          echo "  ‚Ä¢ ghcr.io/ibtisam-iq/debugbox:lite"
          echo "  ‚Ä¢ ghcr.io/ibtisam-iq/debugbox:lite-latest"
          echo "  ‚Ä¢ ghcr.io/ibtisam-iq/debugbox:lite-${VERSION}"
          echo ""
          echo "Balanced variant (default):"
          echo "  ‚Ä¢ ghcr.io/ibtisam-iq/debugbox:balanced"
          echo "  ‚Ä¢ ghcr.io/ibtisam-iq/debugbox:balanced-latest"
          echo "  ‚Ä¢ ghcr.io/ibtisam-iq/debugbox:balanced-${VERSION}"
          echo "  ‚Ä¢ ghcr.io/ibtisam-iq/debugbox:latest (alias)"
          echo "  ‚Ä¢ ghcr.io/ibtisam-iq/debugbox:${VERSION} (alias)"
          echo ""
          echo "Power variant:"
          echo "  ‚Ä¢ ghcr.io/ibtisam-iq/debugbox:power"
          echo "  ‚Ä¢ ghcr.io/ibtisam-iq/debugbox:power-latest"
          echo "  ‚Ä¢ ghcr.io/ibtisam-iq/debugbox:power-${VERSION}"
          echo ""
          echo "All variants passed security scanning"
          echo "Multi-platform: linux/amd64, linux/arm64"
          echo ""
          echo "üìù Next: Create GitHub Release manually at:"
          echo "   https://github.com/ibtisam-iq/debugbox/releases/new?tag=v${VERSION}"
