name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  release:
    name: Build, Scan & Push (Atomic)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: amd64,arm64

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/ibtisam-iq/debugbox
          labels: |
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.url=https://github.com/ibtisam-iq/debugbox
            org.opencontainers.image.source=https://github.com/ibtisam-iq/debugbox
            org.opencontainers.image.documentation=https://debugbox.ibtisam-iq.com
            org.opencontainers.image.vendor=Ibtisam IQ
            org.opencontainers.image.authors=Muhammad Ibtisam <contact@ibtisam-iq.com>

      # Stage 1: Build amd64 only for scanning
      - name: Build all variants (amd64 for scan)
        run: |
          set -e
          variants=("lite" "balanced" "power")
          VERSION="${{ steps.version.outputs.version }}"
          echo "Building all variants (amd64 for scanning)..."
          for variant in "${variants[@]}"; do
            echo "Building $variant (amd64)..."
            docker buildx build \
              --file dockerfiles/Dockerfile.$variant \
              --platform linux/amd64 \
              --tag scan-$variant:$VERSION \
              --output type=docker,dest=/tmp/$variant-amd64.tar \
              .
            echo "Exported $variant to /tmp/$variant-amd64.tar"
          done

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sh -s -- -b /usr/local/bin v0.68.2
          trivy --version

      # Stage 2: Scan all variants
      - name: Scan all variants
        run: |
          set -e
          variants=("lite" "balanced" "power")
          VERSION="${{ steps.version.outputs.version }}"
          echo "Scanning all variants for HIGH/CRITICAL vulnerabilities..."
          for variant in "${variants[@]}"; do
            echo "Scanning $variant..."
            trivy image \
              --input /tmp/$variant-amd64.tar \
              --severity HIGH,CRITICAL \
              --exit-code 1 \
              scan-$variant:$VERSION
            echo "Scan passed for $variant"
          done

      # Stage 3: Push multi-platform only if all scans passed
      - name: Push all variants (multi-platform)
        run: |
          set -e
          variants=("lite" "balanced" "power")
          VERSION="${{ steps.version.outputs.version }}"
          LABELS="${{ steps.meta.outputs.labels }}"
          echo "Pushing all variants (amd64+arm64)..."
          for variant in "${variants[@]}"; do
            echo "Pushing $variant..."
            docker buildx build \
              --file dockerfiles/Dockerfile.$variant \
              --platform linux/amd64,linux/arm64 \
              --tag ghcr.io/ibtisam-iq/debugbox-$variant:$VERSION \
              --tag ghcr.io/ibtisam-iq/debugbox-$variant:latest \
              --tag docker.io/${{ secrets.DOCKERHUB_USERNAME }}/debugbox-$variant:$VERSION \
              --tag docker.io/${{ secrets.DOCKERHUB_USERNAME }}/debugbox-$variant:latest \
              --push \
              .
            echo "Pushed $variant"
          done

          # Unqualified tags for balanced (single build)
          echo "Pushing balanced as unqualified debugbox..."
          docker buildx build \
            --file dockerfiles/Dockerfile.balanced \
            --platform linux/amd64,linux/arm64 \
            --tag ghcr.io/ibtisam-iq/debugbox:$VERSION \
            --tag ghcr.io/ibtisam-iq/debugbox:latest \
            --tag docker.io/${{ secrets.DOCKERHUB_USERNAME }}/debugbox:$VERSION \
            --tag docker.io/${{ secrets.DOCKERHUB_USERNAME }}/debugbox:latest \
            $(echo "$LABELS" | sed 's/^/--label /') \
            --push \
            .

      - name: Release summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo ""
          echo "Release v${VERSION} completed successfully!"
          echo ""
          echo "Published images:"
          echo " • ghcr.io/ibtisam-iq/debugbox-lite:${VERSION}"
          echo " • ghcr.io/ibtisam-iq/debugbox-balanced:${VERSION}"
          echo " • ghcr.io/ibtisam-iq/debugbox-power:${VERSION}"
          echo " • ghcr.io/ibtisam-iq/debugbox:${VERSION} (balanced alias)"
          echo ""
          echo "All variants passed security scanning"
          echo "Multi-platform: linux/amd64, linux/arm64"
