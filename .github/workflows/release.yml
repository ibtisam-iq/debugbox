name: Release

# ============================================================
# Purpose: Build and publish production images to registries
# ============================================================
# This workflow:
# - Builds production-ready multi-arch images (amd64, arm64)
# - Injects OCI labels for metadata compliance
# - Scans with Trivy for security vulnerabilities
# - Publishes to GitHub Container Registry (GHCR) and Docker Hub
#
# IMPORTANT:
# - base variant is maintained separately (manual push)
# - Only publishes: lite, balanced, power variants
#
# Triggered by version tags (e.g., v1.0.0)
# ============================================================

# ============================================================
# Trigger Configuration
# ============================================================
on:
  # Production release via version tags
  push:
    tags:
      - "v*.*.*"  # Matches: v1.0.0, v1.2.3, v2.0.0-beta, etc.

  # Manual trigger (useful for re-releases or testing)
  workflow_dispatch:

# ============================================================
# Permissions (Principle of Least Privilege)
# ============================================================
permissions:
  contents: read   # Read repository contents
  packages: write  # Push to GitHub Container Registry (GHCR)

# ============================================================
# Jobs
# ============================================================
jobs:
  build-and-publish:
    name: Build & Publish Release Images
    runs-on: ubuntu-latest

    # ========================================================
    # Matrix Strategy: Build lite, balanced, power variants
    # ========================================================
    # Note: base variant excluded (maintained manually)
    # ========================================================
    strategy:
      matrix:
        variant: [lite, balanced, power]
      fail-fast: true

    steps:
      # =====================================================
      # Checkout
      # =====================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =====================================================
      # Extract Release Version from Git Tag
      # =====================================================
      # Example: refs/tags/v1.0.0 → 1.0.0
      # =====================================================
      - name: Extract release version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      # =====================================================
      # Multi-Architecture Support (QEMU)
      # =====================================================
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: amd64,arm64

      # =====================================================
      # Docker Buildx (Multi-platform builds)
      # =====================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # =====================================================
      # Security: Install Trivy Scanner
      # =====================================================
      # Final safety gate before publishing images
      # =====================================================
      - name: Install Trivy
        run: |
          set -e
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sh -s -- -b /usr/local/bin v0.68.2
          trivy --version

      # =====================================================
      # Metadata: Extract OCI Labels for ${{ matrix.variant }}
      # =====================================================
      # Generates standard OCI labels for the variant.
      # Auto-generates: created (timestamp), revision (git SHA)
      # Custom labels: licenses, url, source, documentation, vendor, authors
      #
      # These labels are injected into the image Config.Labels
      # =====================================================
      - name: Extract metadata for ${{ matrix.variant }}
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/ibtisam-iq/debugbox-${{ matrix.variant }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/debugbox-${{ matrix.variant }}
          labels: |
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.url=https://github.com/ibtisam-iq/debugbox
            org.opencontainers.image.source=https://github.com/ibtisam-iq/debugbox
            org.opencontainers.image.documentation=https://debugbox.ibtisam-iq.com
            org.opencontainers.image.vendor=Ibtisam IQ
            org.opencontainers.image.authors=Muhammad Ibtisam <contact@ibtisam-iq.com>

      # =====================================================
      # Login: GitHub Container Registry (GHCR)
      # =====================================================
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # =====================================================
      # Login: Docker Hub
      # =====================================================
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # =====================================================
      # Build & Push: ${{ matrix.variant }} variant
      # =====================================================
      # Builds the variant for both architectures (amd64, arm64).
      #
      # Label injection flow:
      #   1. Variant-specific labels from Dockerfile
      #   2. Shared labels from metadata-action (above)
      #   3. Auto-generated labels (created, revision)
      #   → All merged into final image Config.Labels
      #
      # Tags applied:
      #   - Versioned: ghcr.io/.../debugbox-lite:1.0.0
      #   - Latest: ghcr.io/.../debugbox-lite:latest
      #   - Docker Hub: docker.io/.../debugbox-lite:1.0.0
      #   - Docker Hub: docker.io/.../debugbox-lite:latest
      #
      # Special case for balanced (default variant):
      #   - Also tagged as: debugbox:1.0.0, debugbox:latest
      # =====================================================
      - name: Build & push ${{ matrix.variant }} image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: dockerfiles/Dockerfile.${{ matrix.variant }}
          platforms: linux/amd64,linux/arm64
          load: true
          # push: true
          # Tag strategy:
          # - Variant-specific: debugbox-${variant}:version + :latest on GHCR & Docker Hub
          # - For balanced only: unqualified debugbox:version + :latest on both registries
          tags: |
            ghcr.io/ibtisam-iq/debugbox-${{ matrix.variant }}:${{ steps.version.outputs.version }}
            ghcr.io/ibtisam-iq/debugbox-${{ matrix.variant }}:latest
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/debugbox-${{ matrix.variant }}:${{ steps.version.outputs.version }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/debugbox-${{ matrix.variant }}:latest
            ${{ matrix.variant == 'balanced' && format('ghcr.io/ibtisam-iq/debugbox:{0}', steps.version.outputs.version) || '' }}
            ${{ matrix.variant == 'balanced' && 'ghcr.io/ibtisam-iq/debugbox:latest' || '' }}
            ${{ matrix.variant == 'balanced' && format('docker.io/{0}/debugbox:{1}', secrets.DOCKERHUB_USERNAME, steps.version.outputs.version) || '' }}
            ${{ matrix.variant == 'balanced' && format('docker.io/{0}/debugbox:latest', secrets.DOCKERHUB_USERNAME) || '' }}
          labels: ${{ steps.meta.outputs.labels }}
          # ↑ Injects ALL shared labels + auto-generated created/revision
          # No build-args needed for labels!

      # =====================================================
      # Security: Trivy Vulnerability Scan
      # =====================================================
      # Scans the published image for security vulnerabilities.
      #
      # Configuration:
      # - severity: HIGH,CRITICAL
      #   Only report high/critical issues (skip low/medium)
      #
      # - exit-code: 1
      #   Fail release if any HIGH/CRITICAL vulnerabilities found
      #
      # This is the final safety gate before images are public.
      # =====================================================
      - name: Trivy security scan - ${{ matrix.variant }}
        run: |
          trivy image \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            ghcr.io/ibtisam-iq/debugbox-${{ matrix.variant }}:${{ steps.version.outputs.version }}

