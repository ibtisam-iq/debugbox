# DebugBox — Power
FROM debug:base AS base

ARG USER=ibtisam
ARG UID=1000
ARG GID=1000
ARG NO_SUDO=true
ARG YQ_VERSION=v4.50.1
ARG YQ_SHA256=c7a1278e6bbc4924f41b56db838086c39d13ee25dcb22089e7fbf16ac901f0d4

LABEL org.opencontainers.image.title="DebugBox — power" \
      org.opencontainers.image.description="Advanced SRE-grade network forensics and troubleshooting image" \
      org.opencontainers.image.version="0.1.0"

# Switch to root for installs
USER root

RUN set -eux; \
apk add --no-cache \
bash bash-completion \
ca-certificates tzdata \
curl wget \
coreutils util-linux \
busybox-extras \
shadow sudo \
bind-tools \
iproute2 iputils \
iperf3 \
mtr \
netcat-openbsd \
socat \
traceroute \
tcpdump \
iftop \
ethtool \
drill \
nmap \
nmap-nping \
nmap-scripts \
ngrep \
tcptraceroute \
tshark \
libpcap \
iptables \
nftables \
ipvsadm \
ipset \
conntrack-tools \
bird \
bridge-utils \
fping \
speedtest-cli \
vim nano \
jq \
ltrace strace \
file findutils \
net-snmp-tools \
git openssh-client \
py3-pip py3-setuptools \
perl-crypt-ssleay perl-net-ssleay \
websocat; \
rm -rf /var/cache/apk/* /usr/share/man /usr/share/doc /usr/share/locale || true

# Install yq (pinned + verified)
RUN set -eux; \
  wget -qO /usr/local/bin/yq \
    "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"; \
  echo "${YQ_SHA256}  /usr/local/bin/yq" | sha256sum -c -; \
  chmod +x /usr/local/bin/yq

# Add helpful aliases (system-wide already provided by base)
RUN echo "alias sniff='tcpdump -i any -n -s 0'" >> /etc/profile.d/debugbox.sh || true

# Optional sudoers
RUN if [ "$NO_SUDO" = "false" ]; then \
      echo "# DebugBox sudoers" > /etc/sudoers.d/debugbox && \
      echo "Defaults env_keep += \"HOME LANG LC_ALL LC_MESSAGES\"" >> /etc/sudoers.d/debugbox && \
      chmod 0440 /etc/sudoers.d/debugbox; \
    fi

# Back to non-root
USER ${USER}
CMD ["/bin/bash"]
